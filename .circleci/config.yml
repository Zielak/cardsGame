# Javascript Node CircleCI 2.0 configuration file
#
# Check https://circleci.com/docs/2.0/language-javascript/ for more details
#
version: 2.1
executors:
  my-executor:
    docker:
      - image: circleci/node:10.17
    working_directory: ~/repo

jobs:
  install:
    executor: my-executor
    steps:
      - checkout

      # Download and cache dependencies
      - restore_cache:
          name: Restore cache for root dependencies
          keys:
            - v3-dependencies-{{ checksum "package-lock.json" }}
            # fallback to using the latest cache if no exact match is found
            - v3-dependencies-
      - restore_cache:
          name: Restore cache for server dependencies
          keys:
            - v1-serverDeps-{{ checksum "packages/server/package-lock.json" }}
            - v1-serverDeps-
      - restore_cache:
          name: Restore cache for client dependencies
          keys:
            - v1-clientDeps-{{ checksum "packages/client/package-lock.json" }}
            - v1-clientDeps-
      - restore_cache:
          name: Restore cache for utils dependencies
          keys:
            - v1-utilsDeps-{{ checksum "packages/utils/package-lock.json" }}
            - v1-utilsDeps-

      - run: npm install
      - run: npm run bootstrap:ci

      - save_cache:
          name: Save cache for root dependencies
          key: v3-dependencies-{{ checksum "package-lock.json" }}
          paths:
            - node_modules
      - save_cache:
          name: Cache server dependencies
          key: v1-serverDeps-{{ checksum "packages/server/package-lock.json" }}
          paths:
            - packages/server/node_modules
      - save_cache:
          name: Cache client dependencies
          key: v1-clientDeps-{{ checksum "packages/client/package-lock.json" }}
          paths:
            - packages/client/node_modules
      - save_cache:
          name: Cache utils dependencies
          key: v1-utilsDeps-{{ checksum "packages/utils/package-lock.json" }}
          paths:
            - packages/utils/node_modules

      - persist_to_workspace:
          # Must be an absolute path, or relative path from working_directory. This is a directory on the container which is
          # taken to be the root directory of the workspace.
          root: ~/repo
          # Must be relative path from root
          paths:
            - node_modules
            - packages/*/lib
            - packages/*/node_modules

  build-utils:
    executor: my-executor
    steps:
      - checkout
      - attach_workspace:
          at: ~/repo
      - run: npm run build:utils
      - persist_to_workspace:
          root: ~/repo
          paths:
            - node_modules
            - packages/*/lib
            - packages/*/node_modules

  build-server-client:
    executor: my-executor
    steps:
      - checkout
      - attach_workspace:
          at: ~/repo
      - run:
          name: Build Server and Client
          command: |
            npm run build:server
            npm run build:client

  coverage:
    executor: my-executor
    steps:
      - checkout
      - attach_workspace:
          at: ~/repo
      - run:
          name: Test & Coverage report
          command: npm run test:ci

  sonarcloud:
    executor: my-executor
    steps:
      - checkout
      - attach_workspace:
          at: ~/repo
      - sonarcloud/scan

  publish:
    executor: my-executor
    steps:
      - checkout
      - attach_workspace:
          at: ~/repo
      - run:
          name: Publish to NPM
          command: |
            npm set //registry.npmjs.org/:_authToken=$NPM_TOKEN
            npm run ci:publish

orbs:
  sonarcloud: sonarsource/sonarcloud@1.0.1

workflows:
  version: 2
  build-test-and-publish:
    jobs:
      - install

      - build-utils:
          requires:
            - install

      - build-server-client:
          requires:
            - build-utils

      - coverage:
          requires:
            - build-utils

      - sonarcloud:
          context: SonarCloud
          requires:
            - build-utils

      - publish:
          requires:
            - install
            - build-utils
            - build-server-client
            - coverage
          filters:
            branches:
              only: master
            tags:
              only: /v([\.0-9]+)/
